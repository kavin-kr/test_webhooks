version: v0
kind: Pipeline
name: test-pipeline
steps:
  - name: echo-var
    image: alpine/git
    env:
      var1: hello
      var2: world
    command:
      - echo $var1 $var2
    next: "asdfsdf adsfsdf"
  - name: "asdfsdf adsfsdf"
    when:
      event: 
        - tag
    then: 
      "$asd asdfowfksjk"
    else:
      ls
  - name: "$asd asdfowfksjk"
    image: alpine/git
    command: echo "tag is created"   
  - name: ls
    image: alpine/git
    command:
      - ls -la
    next: test-kaniko
  - name: test-kaniko
    image: gcr.io/kaniko-project/executor:debug
    env:
      CI_REGISTRY_USER:
        from_secret: ci_user
      CI_REGISTRY_PASSWORD:
        from_secret: ci_password
    command: |
      # required env variables:
      #   - CI_DOCKER_TAG         : tag used while pushing the image
      #   - CI_REGISTRY_USER      : username for docker registry
      #   - CI_REGISTRY_PASSWORD  : password for docker registry

      # using temp tag
      CI_DOCKER_TAG=$(date +'%m.%d-%H.%M')

      # kaniko will pollute context directory while building docker image
      # copy local repo to different directory 
      cp -va /mnt/workdir/test_webhooks/. /temp-workspace/

      # add docker credentials to kaniko for pushing images
      echo "{\"auths\":{\"registry.patr.cloud\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json

      # now run kaniko to build and push images to docker registry
      /kaniko/executor \
        --context=/temp-workspace/ \
        --destination=registry.patr.cloud/personal-workspace-93f07a889d7c4866ac427027ccf71d0a/test:$CI_DOCKER_TAG
      
      ls -la /
